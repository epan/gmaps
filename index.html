<!DOCTYPE html>
<html>
<head>
	<!-- 
		P0
		TODO: Generate pin objects based on FB friend info.
		TODO: Create proper event handlers to have pins generated the overlay added.
		TODO: Create Info Window for the pins based on FB friend info.
		TODO: Fix the scrolling problem due to header offset.
		TODO: Deal with multi-person at same location.
		
		P1
		TODO: Make a way for user to contact a friend (FB, email?).
		TODO: Make a way for user to book a flight to this place.
		TODO: Make the user image the login/logout info (right-aligned?).
		TODO: Style the login/logout buttons.
		TODO: Customize the marker to show friends' faces.
		TODO: Set fit width for map boundaries so you can see the world on load.

		P2
		TODO: Show flight prices for the coming weekend automatically per city.
		TODO: Give the header a dropshadow and border bottom.
		TODO: Drop the pins in a nice order, like left to right.
		TODO: Make it look nice for mobile.
	 -->
	<title>Prototype for OCEAN and GA with Google Maps</title>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<meta charset="utf-8">
	<style>
		/* Setup for Google Maps API */
		html, body, #map_canvas {
			margin: 0;
			padding: 0;
			height: 100%;
		}
		/* CSS rules for which login/logout buttons to show */
		body.connected #login { display: none; }
		body.connected #logout { display: block; }
		body.not_connected #login { display: block; }
		body.not_connected #logout { display: none; }
		body.default #login { display: block; }
		body.default #logout { display: none; }
		/* My styles */
		body { font-size: 14px; font-family: Helvetica, Arial, sans-serif; line-height: 1.2;}
		.login-logout { float: right; }
		#user-info { float: left; width: 220px; }
		#user-info span { color: #999; font-size: 12px; }
		#user-info img { vertical-align: top; float:left; border: 1px solid #CECECE; padding: 2px; margin-right: 5px; }
		.header { padding: 10px; position: absolute; z-index:2; background: #fff;width: 100%;box-sizing:border-box; height: 80px;}
		#map-canvas { width:100%; height:100%; padding-top: 100px;}
		.name-city { display: inline-block; }
		#go {background-color: rgb(255,130,119); border-color: rgb(157,62,56);}
	</style>
	<script type="text/javascript"
	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCkp21zwGVCj-e4gjw-lmG6aNQ_WwCgZec&sensor=false">
	</script>

	<script type="text/javascript">
	// Initialize Google Maps
		var map;
		var geocoder;
		var markers = [];
		var cities = [
			"Nova Iguaçu",
			"Shanghai",
			"New York, New York",
			"Singapore",
			"Munich"
			// ,
			// "Dallas, Texas",
			// "London, UK",
			// "Rio de Janeiro, Rio de Janeiro",
			// "Mendoza, Argentina",
			// "Bogotá, Colombia",
			// "San Francisco, California",
			// "Beijing, China",
			// "Tokyo, Japan",
			// "Hong Kong",
			// "Kenya",
			// "Seville, Spain"
		];
		var iterator = 0;
		
		var locations = [
			// new google.maps.LatLng(-25.363882,131.044922),
			// new google.maps.LatLng(37.7750, -122.4183),
			// new google.maps.LatLng(35.7750, -120.4183)
		];

		var friendsWithLatLong = [];

		function initialize() {
			var mapOptions = {
				zoom: 2,
				center: new google.maps.LatLng(15.7750, 0),
				mapTypeId: google.maps.MapTypeId.ROADMAP
			};
			map = new google.maps.Map(document.getElementById('map_canvas'),
			mapOptions);
			geocoder = new google.maps.Geocoder();
		}

		google.maps.event.addDomListener(window, 'load', initialize);

	// Geocodes location name into a Lat Long
		function codeAddress(cities) {
			var address = "";
			for (var i = 0; i < cities.length; i++) {
				address = cities[i];
				geocoder.geocode( {'address': address}, function(results, status) {
					if (status == google.maps.GeocoderStatus.OK) {
						locations.push(results[0].geometry.location);
						if (locations.length === cities.length) {
							drop(locations);	
						}
					} else {
						alert("Geocode was not successful because " + status);
					};
				});
			};
		}

	// Test function to append lat-long to FB friend object
		// Receives an array of FB friend objects verified to have a location
		// and location.name that is !null && !undefined. These friend objects
		// have a string for the location name "San Francisco, California" but
		// no lat long info needed to make a pin so this function takes each
		// friend object with location, geocodes the location string, and 
		// appends the object with a lat long object. Each appended object is
		// added to a new array for friend objects with LatLng.
		function codeAddressTest(friendsWithLocation) {
			var i;
			var address = "";
			var friend;
			// Limits to 5 loops right now to avoid QUERY_OVER_LIMIT
			for (i = 0; i < friendsWithLocation.length && i < 5; i++) {
				friend = friendsWithLocation[i];
				address = friend.location.name;
				// Google's geocoder syntax
				geocoder.geocode( {'address': address}, function(results, status) {
					var results = results;
					if (status == google.maps.GeocoderStatus.OK) {
						// Gets the first of all possible geocoder results responses
						// as results[0] and puts the Google LatLng object at 
						// results[0].geometry.location and appends this to the 
						// friend object's location node into a new key value latlong.
						friend.location.latlong = results[0].geometry.location;
						// Adds this newly-appended friend object with LatLng to
						// the array friendsWithLatLong.
						friendsWithLatLong.push(friend);
						console.log(friendsWithLatLong[i]);
						// Determines that it is the last loop and drops markers
						// for each friend object now in friendsWithLatLong.
						if (friendsWithLatLong.length === 5) {
							console.log(friendsWithLatLong);
							drop(friendsWithLatLong);
						}
					} else {
						alert("Geocode was not successful because " + status);
					};
				});
			};
		}

	// Drops the markers by calling addMarker on the array of LatLng objects
		function drop(array) {
			for (var i = 0; i < array.length; i++) {
				setTimeout(function() {
					addMarker(array);
				}, i * 200); // Sets delay between marker drops
			};
		}

	// Creates new Marker object from a markers array of LatLng objects
		function addMarker(array) {
			markers.push(new google.maps.Marker({
				position: array[iterator].location.latlong,
				map: map,
				draggable: false,
				animation: google.maps.Animation.DROP,
				title: array[iterator].name
			}));
			iterator++;
		};

	// // Create and show info windows
	// 	function showInfoWindow(marker) {
	// 		var infowindow = new google.maps.InfoWindow({
	// 			content: "Hello there"
	// 		});
	// 	};

	// // Listener to open info window when click on marker
	// 	google.maps.event.addListener(markers, 'click', function() {
	// 		infowindow.open(map,markers);
	// 	});

	// Initialize FB API 
		window.fbAsyncInit = function() {
			FB.init({
				appId      : '460199387350228', // App ID
				channelUrl : '//ericpan.net/gmaps/channel.html', // Channel File
				status     : true, // check login status
				cookie     : true, // enable cookies to allow the server to access the session
				xfbml      : true  // parse XFBML
			});

			FB.Event.subscribe('auth.statusChange', handleStatusChange);
		};

		// Load the SDK Asynchronously
		(function(d){
			var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
			if (d.getElementById(id)) {return;}
			js = d.createElement('script'); js.id = id; js.async = true;
			js.src = "//connect.facebook.net/en_US/all.js";
			ref.parentNode.insertBefore(js, ref);
		}(document));
	
	// Toggles body class based on FB login response 
		function handleStatusChange(response) {
			document.body.className = response.authResponse ? 'connected' : 'not_connected';

			if (response.authResponse) {
				console.log(response);
				updateUserInfo(response);
			}
		}
	
	// Login the user, ask for permission
		function loginUser() {    
			FB.login(function(response) { }, {scope:'email, user_location, friends_location'});     
		}
	
	// Show the user info at div#user-info if authenticated
		function updateUserInfo(response) {
			FB.api('/me', function(response) {
				document.getElementById('user-info').innerHTML = '<img src="https://graph.facebook.com/' + response.id + '/picture" width="56px" height="56px"><div class="name-city">' + response.name + '<br><span>' + response.location.name; + '</span></div>'
			});
		}

	var friendsWithLocation = [];
	// Get friends' info (name, picture, location)
		function getUserFriends() {

			FB.api("/me/friends&fields=name,picture,location", function(response) {
				// Confirms: Friends request responded
				console.log("Got friends: ", response);
				
				if (!response.error) {
					var friends = response.data;

					for (i = 0; i < friends.length; i++) {
						var friend = friends[i];

						// Check if friend has a location set
						if (friend.location !== undefined && 
							friend.location !== null && 
							friend.location.name !== null &&
							friend.location.name !== undefined) {
							// console.log(friend.name + " " + friend.location.name);
							friendsWithLocation.push(friend);
						}
						if (i === friends.length - 1) {
							codeAddressTest(friendsWithLocation);
						}
					}
				}
			})
		}
		
	</script>
</head>
<body class="default">
	<!-- FB needs this for some reason -->
	<div id="fb-root"></div>

	<div class="header">
		<!-- Show the FB user info if authenticated here -->
		<div id="user-info"></div>

		<!-- Get friends button -->
		<button onClick="getUserFriends();" id="go">Show 5 Friends</button>
		
		<!-- FB Login/Logout buttons -->
		<div class="login-logout">
			<div id="login"><button onClick="loginUser();">Login</button></div>
			<div id="logout"><button  onClick="FB.logout();">Logout</button></div>
		</div>
	</div><!-- .header -->
	<!-- Hook for Google Maps -->
	<div id="map_canvas"></div>
</body>
</html>